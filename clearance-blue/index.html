<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clearance Blue</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- IMPORTANT: this file lives in /clearance-blue/ so style is one level up -->
  <link rel="stylesheet" href="../style.css">

  <style>
    /* Disable any global banner layers from style.css here (if present) */
    body::before,
    body::after{
      display:none !important;
      content:none !important;
    }

    html, body{ height:100%; }

    body{
      margin:0;
      min-height:100svh;
      background:#05070a;
      color:var(--fg);
      font-family:"JetBrains Mono", monospace;
      overflow:hidden;
    }

    .wrap{
      padding:34px 34px 42px;
    }

    .backwrap{
      margin-bottom:14px;
    }
    .backbtn{
      font-size:14px;
      color:var(--dim);
      text-decoration:none;
      display:inline-block;
      padding:2px 0;
      cursor:pointer;
    }
    .backbtn:hover{ color:var(--fg); }

    .title{
      font-size:18px;
      margin:0 0 18px;
      letter-spacing:0.08em;
    }

    .status{
      font-size:13px;
      color:var(--dim);
      line-height:1.55;
      margin-bottom:16px;
      user-select:none;
    }

    .cmdline{
      margin-top:18px;
      font-size:14px;
      position:relative;
    }

    #cmd{
      background:none;
      border:none;
      outline:none;
      color:var(--fg);
      font-family:inherit;
      font-size:14px;
      width:min(560px, 88vw);
      caret-color: var(--fg);
    }

    .hint{
      margin-top:8px;
      color:var(--dim);
      opacity:0.58;
      font-size:12px;
      line-height:1.45;
      user-select:none;
    }

    .output{
      margin-top:18px;
      font-size:14px;
      color:var(--dim);
      white-space:pre-line;
      min-height:56px;
    }

    .hl{
      color:var(--fg);
      opacity:0.92;
      text-decoration: underline;
      text-decoration-thickness: 1px;
      text-underline-offset: 3px;
    }

    .docs{
      margin-top:26px;
      font-size:14px;
      line-height:28px;
    }

    .docs .label{
      color:var(--dim);
      opacity:0.9;
      margin-bottom:8px;
      letter-spacing:0.06em;
    }

    .doc{
      display:block;
      color:var(--fg);
      text-decoration:none;
      width:fit-content;
      max-width: 92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:0.92;
    }

    .doc:hover{ opacity:0.75; }

    /* Small mobile padding */
    @media (max-width: 520px){
      .wrap{ padding:22px 18px 30px; }
      .title{ font-size:16px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="backwrap">
      <a class="backbtn" href="#" id="backBtn">‚Üê BACK</a>
    </div>

    <div class="title">CLEARANCE LEVEL: BLUE</div>

    <div class="status" id="status">
      ACCESS PROFILE: EXTENDED<br>
      VISIBILITY: RESTRICTED DATASETS<br>
      SESSION STATE: VERIFIED
    </div>

    <div class="cmdline">
      &gt; <input id="cmd" autocomplete="off" autocapitalize="off" spellcheck="false" autofocus aria-label="Command input">
      <div class="hint">
        available: help, clear, subjects, archive, world, system, interface, entry, access, search &lt;term&gt;, open &lt;n&gt;, exit
      </div>
    </div>

    <div id="output" class="output"></div>

    <div class="docs" aria-label="Available documents">
      <div class="label">AVAILABLE DOCUMENTS:</div>

      <a class="doc" href="../subjects.html">SUBJECT INDEX (FILTERED)</a>
      <a class="doc" href="../subject-alex.html">SUBJECT: ALEX (EXTENDED)</a>
      <a class="doc" href="../subject-kiwi.html">SUBJECT: KIWI (EXTENDED)</a>
      <a class="doc" href="../subject-mentor.html">SUBJECT: MENTOR (LIMITED)</a>
      <a class="doc" href="../archive.html">ARCHIVE ENTRIES (LIMITED)</a>
      <a class="doc" href="../world.html">WORLD GRID (READ-ONLY)</a>
      <a class="doc" href="../mechanics.html">SYSTEM / MECHANICS</a>
      <a class="doc" href="../interface.html">INTERFACE LAYER</a>
      <a class="doc" href="../index.html">ENTRY (ROOT)</a>
    </div>

  </div>

  <script>
    const input = document.getElementById("cmd");
    const output = document.getElementById("output");
    const backBtn = document.getElementById("backBtn");

    // Always return to system interface
    backBtn.addEventListener("click", (e) => {
      e.preventDefault();
      window.location.href = "../system.html";
    });

    // Session key used on system.html (kept consistent)
    const ACCESS_LEVEL_KEY = "hl_access_level_v1";

    // Enforce BLUE session on this page (soft)
    function getAccessLevel(){
      const v = parseInt(sessionStorage.getItem(ACCESS_LEVEL_KEY) || "0", 10);
      return Number.isFinite(v) ? Math.max(0, Math.min(3, v)) : 0;
    }
    function setAccessLevel(n){
      const lvl = Math.max(0, Math.min(3, n));
      sessionStorage.setItem(ACCESS_LEVEL_KEY, String(lvl));
    }
    if (getAccessLevel() < 1) setAccessLevel(1);

    // Search index (BLUE-allowed subset)
    // IMPORTANT: use paths relative to /clearance-blue/
    const INDEX = [
      { key:"subjects",  title:"SUBJECTS",  url:"../subjects.html",       tags:["profiles","entities","index","persons"] },
      { key:"alex",      title:"ALEX",      url:"../subject-alex.html",   tags:["subject","profile","s-001","leader"] },
      { key:"kiwi",      title:"KIWI",      url:"../subject-kiwi.html",   tags:["subject","profile","s-003"] },
      { key:"mentor",    title:"MENTOR",    url:"../subject-mentor.html", tags:["subject","profile","s-002","redacted"] },
      { key:"archive",   title:"ARCHIVE",   url:"../archive.html",        tags:["logs","records","history","files"] },
      { key:"world",     title:"WORLD",     url:"../world.html",          tags:["map","regions","grid","tension","global"] },
      { key:"system",    title:"SYSTEM",    url:"../mechanics.html",      tags:["rules","protocol","mechanics","core"] },
      { key:"mechanics", title:"MECHANICS", url:"../mechanics.html",      tags:["system","logic","structure"] },
      { key:"interface", title:"INTERFACE", url:"../interface.html",      tags:["ui","layer","transition"] },
      { key:"entry",     title:"ENTRY",     url:"../index.html",          tags:["start","gateway","root"] }
    ];

    let LAST_RESULTS = [];

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeRegExp(s){
      return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function renderLines(lines, highlightTerm){
      const term = (highlightTerm || "").trim();
      const out = (lines || []).map(line => {
        let safe = escapeHtml(line);
        if (term && term.length >= 2){
          const re = new RegExp(escapeRegExp(term), "i");
          safe = safe.replace(re, (m) => `<span class="hl">${escapeHtml(m)}</span>`);
        }
        return `> ${safe}`;
      }).join("<br>");
      output.innerHTML = out;
    }

    function respond(text){ renderLines([text], ""); }
    function respondMulti(lines, highlightTerm){ renderLines(lines, highlightTerm || ""); }

    function scoreHit(q, item){
      const s = q.toLowerCase();
      const key = item.key.toLowerCase();
      const title = item.title.toLowerCase();
      const tags = (item.tags || []).join(" ").toLowerCase();

      if (key === s) return 100;
      if (title === s) return 90;
      if (key.startsWith(s)) return 70;
      if (title.includes(s)) return 55;
      if (tags.includes(s)) return 35;
      return 0;
    }

    function doSearch(query){
      const q = (query || "").trim();
      if (!q) return [];
      return INDEX
        .map(it => ({ it, sc: scoreHit(q, it) }))
        .filter(x => x.sc > 0)
        .sort((a,b) => b.sc - a.sc)
        .map(x => x.it)
        .slice(0, 7);
    }

    function go(url, msg, meta){
      const lines = [];
      if (msg) lines.push(msg);
      if (meta && meta.length) lines.push(...meta);

      const parsing = ["PARSING...","ROUTE RESOLUTION...","LINK ESTABLISHED"];
      respondMulti(lines.length ? lines : ["PARSING..."]);

      setTimeout(() => {
        respondMulti([...lines, ...parsing]);
        setTimeout(() => { window.location.href = url; }, 420);
      }, 240);
    }

    const history = [];
    let histPos = -1;

    function pushHistory(cmd){
      const c = (cmd || "").trim();
      if (!c) return;
      if (history.length && history[history.length - 1] === c) return;
      history.push(c);
      if (history.length > 50) history.shift();
      histPos = history.length;
    }
    function histUp(){
      if (!history.length) return;
      histPos = Math.max(0, histPos - 1);
      input.value = history[histPos] || "";
    }
    function histDown(){
      if (!history.length) return;
      histPos = Math.min(history.length, histPos + 1);
      input.value = history[histPos] || "";
    }

    function help(){
      respondMulti([
        "BLUE PROFILE COMMAND SET",
        "NAV: subjects, archive, world, system, interface, entry",
        "SEARCH: search <term>  OR  <term>",
        "OPEN: open <n>  (from last results)",
        "STATUS: access",
        "UTILITY: clear",
        "EXIT: exit"
      ]);
    }

    function nav(node){
      const map = {
        subjects:  {msg:"OPEN NODE: SUBJECTS",  url:"../subjects.html"},
        archive:   {msg:"OPEN NODE: ARCHIVE",   url:"../archive.html"},
        world:     {msg:"OPEN NODE: WORLD",     url:"../world.html"},
        system:    {msg:"OPEN NODE: SYSTEM",    url:"../mechanics.html"},
        mechanics: {msg:"OPEN NODE: SYSTEM",    url:"../mechanics.html"},
        interface: {msg:"OPEN NODE: INTERFACE", url:"../interface.html"},
        entry:     {msg:"RETURNING TO ENTRY",   url:"../index.html"}
      };
      return map[node] || null;
    }

    input.addEventListener("keydown", (e) => {
      if (e.key === "ArrowUp"){ e.preventDefault(); histUp(); return; }
      if (e.key === "ArrowDown"){ e.preventDefault(); histDown(); return; }
      if (e.key !== "Enter") return;

      const raw = input.value.trim();
      const cmd = raw.toLowerCase();
      input.value = "";

      if (!cmd){
        respond("AWAITING INPUT");
        return;
      }

      pushHistory(raw);

      if (cmd === "help"){ help(); return; }
      if (cmd === "clear"){ output.textContent = ""; return; }
      if (cmd === "exit"){ go("../system.html", "RETURNING TO SYSTEM INTERFACE", []); return; }

      if (cmd === "access"){
        respondMulti(["CLEARANCE STATUS", "LEVEL: BLUE", "LINE: BLUE LINE"]);
        return;
      }

      if (cmd.startsWith("open ")){
        const n = parseInt(cmd.slice(5).trim(), 10);
        if (!Number.isFinite(n) || n < 1 || n > LAST_RESULTS.length){
          respond("OPEN: INVALID INDEX");
          return;
        }
        const hit = LAST_RESULTS[n - 1];
        go(hit.url, "OPENING: " + hit.title, [
          "MATCH: " + hit.title + "  KEY: " + hit.key,
          "ROUTE: " + hit.url
        ]);
        return;
      }

      if (cmd.startsWith("search ")){
        const q = raw.slice(7).trim();
        const hits = doSearch(q);
        LAST_RESULTS = hits;

        if (!hits.length){
          respond("SEARCH: NO RESULTS");
          return;
        }

        if (hits.length === 1){
          go(hits[0].url, "SEARCH HIT: " + hits[0].title, [
            "MATCH: " + hits[0].title + "  KEY: " + hits[0].key,
            "ROUTE: " + hits[0].url
          ]);
          return;
        }

        respondMulti([
          "SEARCH RESULTS:",
          ...hits.map((h,i) => `${i+1}) ${h.title}  [${h.key}]`),
          "TYPE: open <n>"
        ], q);
        return;
      }

      // direct nav
      const n = nav(cmd);
      if (n){
        go(n.url, n.msg, [
          "MATCH: " + cmd.toUpperCase(),
          "ROUTE: " + n.url
        ]);
        return;
      }

      // implicit search
      {
        const hits = doSearch(raw);
        LAST_RESULTS = hits;

        if (hits.length === 1){
          go(hits[0].url, "SEARCH HIT: " + hits[0].title, [
            "MATCH: " + hits[0].title + "  KEY: " + hits[0].key,
            "ROUTE: " + hits[0].url
          ]);
          return;
        }

        if (hits.length > 1){
          respondMulti([
            "SEARCH RESULTS:",
            ...hits.map((h,i) => `${i+1}) ${h.title}  [${h.key}]`),
            "TYPE: open <n>"
          ], raw);
          return;
        }
      }

      respond("COMMAND NOT AVAILABLE IN BLUE PROFILE");
    });

    window.addEventListener("load", () => {
      try{ input.focus(); }catch(e){}
    });
  </script>

</body>
</html>