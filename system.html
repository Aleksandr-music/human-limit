<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>System Interface</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css">

  <style>
    :root{
      --banner: url("images/png/hl-system-layered-banner-01.png");

      /* overlay alpha (separate from --dim color in style.css) */
      --bg-dim-alpha: 0.04;

      /* Desktop 3D parallax state (updated by JS) */
      --rx: 0deg;
      --ry: 0deg;
      --tx: 0px;
      --ty: 0px;

      /* Mobile/Android 2D drift state (updated by JS) */
      --mx: 0px;
      --my: 0px;
    }

    /* Disable global banner layers from style.css on this page */
    body::before,
    body::after{
      display:none !important;
      content:none !important;
    }

    html, body { height:100%; }

    body{
      margin:0;
      min-height:100svh;
      overflow:hidden;
    }

    /* --- background stage --- */
    .bg{
      position:fixed;
      inset:0;
      z-index:-2;
      overflow:hidden;
      background:#0b0b0b;

      /* Desktop/iPad: 3D stage */
      perspective: 900px;
      transform-style: preserve-3d;
    }

    .bg-scene{
      position:absolute;
      inset:-4vh -4vw;
      transform-style: preserve-3d;
      will-change: transform;

      transform:
        translate3d(var(--tx), var(--ty), 0)
        rotateX(var(--rx))
        rotateY(var(--ry));
    }

    .bg-layer{
      position:absolute;
      inset:0;

      background-image: var(--banner);
      background-repeat:no-repeat;
      background-position:center center;
      background-size:cover;

      will-change: transform;
      transform-style: preserve-3d;

      backface-visibility:hidden;
      -webkit-backface-visibility:hidden;
      transform: translateZ(0);
    }

    /* Desktop/iPad depth: Z translation (crisp) */
    .bg-layer-1{ opacity:1;    transform: translateZ(-60px) scale(1.02); }
    .bg-layer-2{ opacity:0.45; transform: translateZ(-20px) scale(1.01); }
    .bg-layer-3{ opacity:0.22; transform: translateZ( 20px) scale(1.00); }

    .bg-fx{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0.10;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.05) 0px,
          rgba(255,255,255,0.05) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 6px
        );
      transform: translateZ(80px);
    }

    .bg-dim{
      position:absolute;
      inset:0;
      pointer-events:none;
      background: rgba(0,0,0,var(--bg-dim-alpha));
      transform: translateZ(90px);
    }

    /* Mobile/tablet defaults */
    @media (max-width: 980px){
      :root{ --bg-dim-alpha: 0.06; }
      .bg-layer{ background-size:cover; background-position:center center; }
    }

    /* =========================================================
       ANDROID FIX:
       - kill 3D stage (perspective/translateZ/scene transform)
       - animate ONLY layers in 2D via --mx/--my (stable)
       ========================================================= */
    html.android .bg{
      perspective:none !important;
      transform-style: flat !important;
    }

    /* IMPORTANT: bg-scene becomes a static container on Android */
    html.android .bg-scene{
      inset:-3vh -3vw;
      transform:none !important;
      will-change:auto !important;
    }

    /* Remove any Z stacking on Android (main flicker source) */
    html.android .bg-layer{
      transform-style: flat !important;
      backface-visibility: visible !important;
      -webkit-backface-visibility: visible !important;
      will-change: transform;
      transform: none !important; /* reset base */
    }

    /* 2D depth via different motion multipliers + tiny scale */
    html.android .bg-layer-1{
      opacity:1;
      transform: translate3d(calc(var(--mx) * 0.14), calc(var(--my) * 0.14), 0) scale(1.01) !important;
    }
    html.android .bg-layer-2{
      opacity:0.40;
      transform: translate3d(calc(var(--mx) * 0.32), calc(var(--my) * 0.32), 0) scale(1.015) !important;
    }
    html.android .bg-layer-3{
      opacity:0.20;
      transform: translate3d(calc(var(--mx) * 0.55), calc(var(--my) * 0.55), 0) scale(1.02) !important;
    }

    html.android .bg-fx,
    html.android .bg-dim{
      transform:none !important;
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      .bg-scene{ transform:none !important; }
      html.android .bg-layer{ transform:none !important; }
    }

    /* --- page-specific (system.html only) --- */
    .title{
      font-size:18px;
      margin-bottom:26px;
    }

    .menu .node{
      display:block;
      font-size:16px;
      line-height:30px;
    }

    .menu .node--service{
      margin-top:10px;
      font-size:14px;
      color:var(--dim);
    }
    .menu .node--service::before{ color:var(--dim); }
    .menu .node--service:hover{ color:var(--fg); }

    .status{
      margin-top:34px;
      font-size:13px;
    }

    .cmdline{
      margin-top:28px;
      font-size:14px;
    }

    #cmd{
      background:none;
      border:none;
      outline:none;
      color:var(--fg);
      font-family:"JetBrains Mono", monospace;
      font-size:14px;
      width:min(520px, 84vw);
    }

    .output{
      margin-top:18px;
      font-size:14px;
      color:var(--dim);
      min-height:18px;
      white-space:pre-line;
    }
  </style>
</head>

<body>

  <!-- layered background -->
  <div class="bg" aria-hidden="true">
    <div class="bg-scene" id="bgScene">
      <div class="bg-layer bg-layer-1"></div>
      <div class="bg-layer bg-layer-2"></div>
      <div class="bg-layer bg-layer-3"></div>
      <div class="bg-fx"></div>
      <div class="bg-dim"></div>
    </div>
  </div>

  <div class="title">HUMAN LIMIT â€” SYSTEM INTERFACE</div>

  <nav class="menu" aria-label="System nodes">
    <a class="node" href="world.html">WORLD</a>
    <a class="node" href="mechanics.html">SYSTEM</a>
    <a class="node" href="subjects.html">SUBJECTS</a>
    <a class="node" href="archive.html">ARCHIVE</a>

    <a class="node node--service" href="state.html">STATE MONITOR</a>
  </nav>

  <div class="status dim">
    ACCESS STATUS: ACTIVE<span class="cursor">_</span>
  </div>

  <div class="cmdline">
    > <input
        id="cmd"
        autofocus
        inputmode="text"
        autocomplete="off"
        autocapitalize="off"
        spellcheck="false"
        aria-label="Command input"
      >
  </div>

  <div id="output" class="output"></div>

  <script>
    // =========================================================
    // 0) Platform mode: ANDROID => 2D drift only (no flicker)
    // =========================================================
    (() => {
      const ua = navigator.userAgent || "";
      const isAndroid = /Android/i.test(ua);
      if (isAndroid) document.documentElement.classList.add("android");
    })();

    // =========================================================
    // 1) Background motion:
    //    - Desktop: pointer 3D parallax
    //    - iPad/iOS touch: slow idle 3D drift (NO gyro)
    //    - Android: very slow idle 2D drift (stable)
    // =========================================================
    (() => {
      const root = document.documentElement;

      const reduce = matchMedia("(prefers-reduced-motion: reduce)").matches;
      if (reduce) return;

      const isAndroid = root.classList.contains("android");
      const canHover = matchMedia("(hover: hover)").matches;

      // --- ANDROID: slow 2D drift (requested) ---
      if (isAndroid){
        let t0 = performance.now();
        function tick(now){
          const t = (now - t0) / 1000;

          // VERY slow, small amplitude
          const mx = Math.sin(t * 0.10) * 9;  // px
          const my = Math.cos(t * 0.08) * 6;  // px

          root.style.setProperty("--mx", mx.toFixed(2) + "px");
          root.style.setProperty("--my", my.toFixed(2) + "px");

          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
        return;
      }

      // --- DESKTOP: pointer-driven 3D parallax ---
      if (canHover){
        const MAX_ROT = 6;   // deg
        const MAX_MOV = 14;  // px

        let tx=0, ty=0, rx=0, ry=0;
        let cx=0, cy=0, crx=0, cry=0;
        let raf=0;

        function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
        function apply(){
          root.style.setProperty("--tx", cx.toFixed(2) + "px");
          root.style.setProperty("--ty", cy.toFixed(2) + "px");
          root.style.setProperty("--rx", crx.toFixed(2) + "deg");
          root.style.setProperty("--ry", cry.toFixed(2) + "deg");
        }
        function tick(){
          raf = 0;
          cx  += (tx  - cx)  * 0.08;
          cy  += (ty  - cy)  * 0.08;
          crx += (rx  - crx) * 0.08;
          cry += (ry  - cry) * 0.08;
          apply();

          if (
            Math.abs(tx-cx)  > 0.08 ||
            Math.abs(ty-cy)  > 0.08 ||
            Math.abs(rx-crx) > 0.05 ||
            Math.abs(ry-cry) > 0.05
          ){
            raf = requestAnimationFrame(tick);
          }
        }
        function schedule(){ if(!raf) raf = requestAnimationFrame(tick); }

        window.addEventListener("pointermove", (e) => {
          const w = window.innerWidth || 1;
          const h = window.innerHeight || 1;
          const nx = (e.clientX / w) * 2 - 1;
          const ny = (e.clientY / h) * 2 - 1;

          tx = clamp(nx * MAX_MOV, -MAX_MOV, MAX_MOV);
          ty = clamp(ny * MAX_MOV, -MAX_MOV, MAX_MOV);
          ry = clamp(nx * MAX_ROT, -MAX_ROT, MAX_ROT);
          rx = clamp(-ny * MAX_ROT, -MAX_ROT, MAX_ROT);

          schedule();
        }, { passive:true });

        return;
      }

      // --- TOUCH (iPad/iOS): slow idle 3D drift, NO gyro ---
      let t0 = performance.now();
      function idle(now){
        const t = (now - t0) / 1000;

        const ry = Math.sin(t * 0.14) * 2.2;   // deg
        const rx = Math.cos(t * 0.11) * 1.6;   // deg
        const tx = Math.sin(t * 0.12) * 6.0;   // px
        const ty = Math.cos(t * 0.10) * 4.0;   // px

        root.style.setProperty("--ry", ry.toFixed(2) + "deg");
        root.style.setProperty("--rx", rx.toFixed(2) + "deg");
        root.style.setProperty("--tx", tx.toFixed(2) + "px");
        root.style.setProperty("--ty", ty.toFixed(2) + "px");

        requestAnimationFrame(idle);
      }
      requestAnimationFrame(idle);
    })();

    // =========================================================
    // 2) Command console + internal search (site "router")
    // =========================================================
    const input = document.getElementById("cmd");
    const output = document.getElementById("output");

    function focusCmd(){
      setTimeout(() => { try{ input.focus(); }catch(e){} }, 0);
    }

    function respond(text){
      output.textContent = "> " + text;
      focusCmd();
    }

    function respondMulti(lines){
      output.textContent = "> " + lines.join("\n> ");
      focusCmd();
    }

    function nav(node){
      const map = {
        world:   {msg:"ACCESSING WORLD NODE",     url:"world.html"},
        system:  {msg:"ACCESSING SYSTEM NODE",    url:"mechanics.html"},
        mechanics:{msg:"ACCESSING SYSTEM NODE",   url:"mechanics.html"},
        subjects:{msg:"ACCESSING SUBJECTS NODE",  url:"subjects.html"},
        archive: {msg:"ACCESSING ARCHIVE NODE",   url:"archive.html"},
        state:   {msg:"ACCESSING STATE MONITOR",  url:"state.html"},
        monitor: {msg:"ACCESSING STATE MONITOR",  url:"state.html"},
        entry:   {msg:"RETURNING TO ENTRY POINT", url:"index.html"},
        interface:{msg:"ACCESSING INTERFACE NODE",url:"interface.html"}
      };
      return map[node] || null;
    }

    // --- internal search index (matches your actual filenames) ---
    const INDEX = [
      { key:"world",     title:"WORLD",     url:"world.html",          tags:["map","regions","grid","tension","global"] },

      { key:"system",    title:"SYSTEM",    url:"mechanics.html",      tags:["rules","protocol","mechanics","laws","core"] },
      { key:"mechanics", title:"MECHANICS", url:"mechanics.html",      tags:["system","logic","structure"] },

      { key:"subjects",  title:"SUBJECTS",  url:"subjects.html",       tags:["profiles","entities","index","persons"] },
      { key:"alex",      title:"ALEX",      url:"subject-alex.html",   tags:["subject","profile","s-001"] },
      { key:"kiwi",      title:"KIWI",      url:"subject-kiwi.html",   tags:["subject","profile","s-003"] },
      { key:"mentor",    title:"MENTOR",    url:"subject-mentor.html", tags:["subject","profile","redacted"] },

      { key:"archive",   title:"ARCHIVE",   url:"archive.html",        tags:["logs","records","history","files"] },

      { key:"state",     title:"STATE",     url:"state.html",          tags:["monitor","status","telemetry","system state"] },

      { key:"entry",     title:"ENTRY",     url:"index.html",          tags:["start","gateway","root"] },
      { key:"interface", title:"INTERFACE", url:"interface.html",      tags:["ui","layer","transition"] }
    ];

    let LAST_RESULTS = [];

    function scoreHit(q, item){
      const s = q.toLowerCase();
      const key = item.key.toLowerCase();
      const title = item.title.toLowerCase();
      const tags = (item.tags || []).join(" ").toLowerCase();

      if (key === s) return 100;
      if (title === s) return 90;
      if (key.startsWith(s)) return 70;
      if (title.includes(s)) return 55;
      if (tags.includes(s)) return 35;
      return 0;
    }

    function doSearch(query){
      const q = (query || "").trim();
      if (!q) return [];

      return INDEX
        .map(it => ({ it, sc: scoreHit(q, it) }))
        .filter(x => x.sc > 0)
        .sort((a,b) => b.sc - a.sc)
        .map(x => x.it)
        .slice(0, 6);
    }

    function restricted(cmd){
      if(cmd === "help"){
        respondMulti([
          "LIMITED PROTOCOL AVAILABLE",
          "NAV: world | system | subjects | archive | state | entry",
          "QUERY: subjects:list | subject <key>",
          "SEARCH: search <term> | <term> (implicit)",
          "OPEN: open <n> (from last results)",
          "UTILITY: clear"
        ]);
        return "__handled__";
      }

      if(cmd === "override"){
        respondMulti([
          "OVERRIDE REJECTED",
          "AUDIT LOG ENTRY CREATED",
          "DEVIATION FLAGGED"
        ]);
        return "__handled__";
      }

      if(cmd === "exit") return "NO EXIT PARAMETERS FOUND";
      return null;
    }

    const SUBJECTS = {
      alex:   {id:"S-001", status:"ACTIVE",   access:"LIMITED", page:"subject-alex.html"},
      kiwi:   {id:"S-003", status:"ACTIVE",   access:"LIMITED", page:"subject-kiwi.html"},
      mentor: {id:"S-002", status:"REDACTED", access:"DENIED",  page:"subject-mentor.html"}
    };

    const OBSERVE = {
      alex:   "OBSERVATION: ACTIVE / CHANNELS: MULTIPLE",
      kiwi:   "OBSERVATION: ACTIVE / CHANNELS: LIMITED",
      mentor: "OBSERVATION: DISALLOWED / REQUEST LOGGED"
    };

    function subjectLookup(key){
      const k = (key || "").toLowerCase().trim();
      const rec = SUBJECTS[k];
      if(!rec) return null;

      if(k === "mentor"){
        return [
          "RECORD FOUND",
          "SUBJECT: MENTOR",
          "ID: " + rec.id,
          "STATUS: " + rec.status,
          "ACCESS: " + rec.access,
          "DETAILS: [REDACTED]"
        ];
      }

      return [
        "RECORD FOUND",
        "SUBJECT: " + k.toUpperCase(),
        "ID: " + rec.id,
        "STATUS: " + rec.status,
        "ACCESS: " + rec.access
      ];
    }

    function go(url, msg){
      if (msg) respond(msg);
      setTimeout(() => { window.location.href = url; }, 360);
    }

    input.addEventListener("keydown", (e) => {
      if(e.key !== "Enter") return;

      const raw = input.value.trim();
      const value = raw.toLowerCase();
      input.value = "";

      if(!value){
        respond("AWAITING INPUT");
        return;
      }

      if(value === "clear"){
        output.textContent = "";
        focusCmd();
        return;
      }

      const r = restricted(value);
      if(r){
        if(r !== "__handled__") respond(r);
        return;
      }

      if(value === "drift"){
        respondMulti([
          "DRIFT STATUS",
          "LEVEL: WITHIN TOLERANCE",
          "OBSERVABILITY: LIMITED",
          "DISCLOSURE: NOT REQUIRED"
        ]);
        return;
      }

      if(value === "observe"){
        respondMulti([
          "OBSERVATION PROTOCOL",
          "FORMAT: observe <subject>",
          "DISCLOSURE: MINIMAL"
        ]);
        return;
      }

      if(value.startsWith("observe ")){
        const key = value.slice("observe ".length).trim();
        respond(OBSERVE[key] || "OBSERVATION: NO TARGET FOUND");
        return;
      }

      if(value === "subjects:list" || value === "subject:list"){
        respondMulti([
          "SUBJECT INDEX AVAILABLE",
          "QUERY FORMAT: subject <key>",
          "KNOWN KEYS: alex, mentor, kiwi"
        ]);
        return;
      }

      if(value.startsWith("subject ")){
        const key = value.slice("subject ".length).trim();
        if(!key){
          respond("SUBJECT KEY REQUIRED");
          return;
        }
        const lines = subjectLookup(key);
        if(lines) respondMulti(lines);
        else respond("NO RECORD FOUND");
        return;
      }

      // OPEN <n>
      if (value.startsWith("open ")){
        const n = parseInt(value.slice(5).trim(), 10);
        if (!Number.isFinite(n) || n < 1 || n > LAST_RESULTS.length){
          respond("OPEN: INVALID INDEX");
          return;
        }
        const hit = LAST_RESULTS[n-1];
        go(hit.url, "OPENING: " + hit.title);
        return;
      }

      // SEARCH <term>
      if (value.startsWith("search ")){
        const q = raw.slice(7).trim();
        const hits = doSearch(q);
        LAST_RESULTS = hits;

        if (!hits.length){
          respond("SEARCH: NO RESULTS");
          return;
        }

        if (hits.length === 1){
          go(hits[0].url, "SEARCH HIT: " + hits[0].title);
          return;
        }

        respondMulti([
          "SEARCH RESULTS:",
          ...hits.map((h,i) => `${i+1}) ${h.title}  [${h.key}]`),
          "TYPE: open <n>"
        ]);
        return;
      }

      // direct NAV by key
      const res = nav(value);
      if(res){
        go(res.url, res.msg);
        return;
      }

      // implicit search (typing any term)
      {
        const hits = doSearch(raw);
        LAST_RESULTS = hits;

        if (hits.length === 1){
          go(hits[0].url, "SEARCH HIT: " + hits[0].title);
          return;
        }

        if (hits.length > 1){
          respondMulti([
            "SEARCH RESULTS:",
            ...hits.map((h,i) => `${i+1}) ${h.title}  [${h.key}]`),
            "TYPE: open <n>"
          ]);
          return;
        }
      }

      respond("COMMAND NOT RECOGNIZED");
    });

    window.addEventListener("load", focusCmd);
  </script>

</body>
</html>